<!DOCTYPE html>
<html>
<head>
    <title>Storage Initialization & Setup</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .code { background: #f5f5f5; padding: 10px; border-radius: 3px; font-family: monospace; margin: 10px 0; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>Storage Initialization & Setup</h1>
    
    <div class="step">
        <h2>Step 1: Initialize Storage Bucket</h2>
        <button onclick="initStorage()">Initialize Storage Bucket</button>
        <div id="result"></div>
    </div>

    <div class="step">
        <h2>Step 2: Set Up Storage Policies (Required)</h2>
        <p class="warning">After initializing the bucket, you MUST set up the RLS policies manually in Supabase Dashboard.</p>
        
        <h3>Go to Supabase Dashboard:</h3>
        <ol>
            <li>Open your Supabase project dashboard</li>
            <li>Go to <strong>Storage</strong> â†’ <strong>Policies</strong></li>
            <li>Select the <code>affirmation-images</code> bucket</li>
            <li>Add the following policies:</li>
        </ol>

        <div class="code">
CREATE POLICY "Authenticated users can upload affirmation images"<br>
ON storage.objects FOR INSERT<br>
WITH CHECK (<br>
&nbsp;&nbsp;bucket_id = 'affirmation-images' <br>
&nbsp;&nbsp;AND auth.role() = 'authenticated'<br>
);
        </div>

        <div class="code">
CREATE POLICY "Public read access for affirmation images"<br>
ON storage.objects FOR SELECT<br>
USING (bucket_id = 'affirmation-images');
        </div>

        <div class="code">
CREATE POLICY "Users can update their own affirmation images"<br>
ON storage.objects FOR UPDATE<br>
USING (<br>
&nbsp;&nbsp;bucket_id = 'affirmation-images' <br>
&nbsp;&nbsp;AND auth.role() = 'authenticated'<br>
);
        </div>

        <div class="code">
CREATE POLICY "Users can delete their own affirmation images"<br>
ON storage.objects FOR DELETE<br>
USING (<br>
&nbsp;&nbsp;bucket_id = 'affirmation-images' <br>
&nbsp;&nbsp;AND auth.role() = 'authenticated'<br>
);
        </div>
    </div>

    <div class="step">
        <h2>Step 3: Database Migration (If Needed)</h2>
        <p>If you haven't already, add the image fields to your affirmations table:</p>
        <div class="code">
ALTER TABLE affirmations <br>
ADD COLUMN image_url TEXT,<br>
ADD COLUMN image_alt_text TEXT,<br>
ADD COLUMN is_manual_image BOOLEAN DEFAULT false;
        </div>
    </div>

    <script>
        async function initStorage() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = 'Initializing storage...';
            
            try {
                const response = await fetch('http://localhost:3001/api/storage/init', {
                    method: 'POST',
                });
                
                const text = await response.text();
                console.log('Response status:', response.status);
                console.log('Response text:', text);
                
                try {
                    const json = JSON.parse(text);
                    if (json.success) {
                        resultDiv.innerHTML = `<div class="success"><strong>Success!</strong><br>${json.message}</div>`;
                    } else {
                        resultDiv.innerHTML = `<div class="error"><strong>Error:</strong><br>${json.error}</div>`;
                    }
                } catch (parseError) {
                    resultDiv.innerHTML = `<div class="error">Error parsing JSON: ${parseError.message}<br><br>Raw response:<br>${text}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">Fetch error: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>

